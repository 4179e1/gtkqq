Jet().$package(qqweb.app.myPanel=new qqweb.businessClass.App(qqweb.portal.getSystemConfig("myPanel")),function(k){var v=this,t=k.dom,s=k.event,l=qqweb.layout.getDesktop().body,m=qqweb.layout.getPanel("qqBar").body;var h,o,p,a,u,j,w,f,d,q,e,b;var x="";var n=function(A){var D=t.node("div",{id:"EQQ_MyPanel","class":"EQQ_myPanel"});var B='					<img id="EQQ_MyAvatar" class="EQQ_myAvatar" uin='+A.uin+' src="'+qqweb.util.getUserAvatar(A.uin,1)+"&t="+(new Date()).getTime()+'" />					<div class="EQQ_myInfo">						<div id="EQQ_MyState" class="EQQ_myState" title="我的状态">							<div id="EQQ_MyStateShow" class="EQQ_myStateShow EQQ_offline">状态</div>							<div class="EQQ_myStateDown">下</div>						</div>						<div id="EQQ_MyNick" class="EQQ_myNick" title="<%=uin%>"><%=uin%></div>						<!--div id="EQQ_MyPanel_ExitButton" title="退出">退出</div-->					</div>					<div id="EQQ_myService" class="EQQ_myService">						<a id="EQQ_qZoneButton" class="EQQ_qZoneButton" title="QQ空间" hidefocus href="###" target="_blank"></a>						<!--a id="EQQ_qqMailButton" class="EQQ_qqMailButton" title="QQ邮箱" hidefocus target="_blank" href="http://mail.qq.com/cgi-bin/login?fun=passport&from=webqq"></a>						<a id="EQQ_sosoButton" class="EQQ_sosoButton" title="搜搜" hidefocus target="_blank" href="http://soso.qq.com/q?bid=200"></a>						<a id="EQQ_qqVipButton" class="EQQ_qqVipButton" title="QQ Vip 会员" hidefocus target="_blank" href="http://vip.qq.com/"></a-->						<a href="###" id="EQQ_MySignature" class="EQQ_mySignature" title=""></a>						<label class="EQQ_mySignature_label"><input type="text" id="EQQ_mySignature_input" title="按ESC取消编辑" /></label>					</div>					';if(isNaN(A.uin)){A.uin="请登录";}B=k.string.template(B,A);D.innerHTML=B;m.innerHTML="";m.appendChild(D);j=D;j.style.display="none";var z=t.node("div",{"class":"EQQ_myPanel_noLogin"});var C='<div style="float: right; margin-top: 12px; margin-right: 50px;">欢迎您，请<a href="###" id="qqbar_login_link">登录</a></div><img src="style/images/avatar.png"/>';z.innerHTML="";m.appendChild(z);w=z;f=t.id("EQQ_MySignature");e=t.id("EQQ_mySignature_input");s.on(f,"click",r.onSignatureClicked);h=t.id("EQQ_MyPanel");o=t.id("EQQ_MyAvatar");p=t.id("EQQ_MyNick");a=t.id("EQQ_MyState");u=t.id("EQQ_MyStateShow");q=t.id("EQQ_qZoneButton");b=t.id("EQQ_MyPanel_ExitButton");s.on(o,"click",r.onMyPanelMyAvatarClick);s.on(q,"click",r.onQZoneButtonClick);if(qqweb.portal.getLoginLevel()==qqweb.CONST.LOGIN_LEVEL_ALL){s.on(o,"mouseover",r.onMyPanelMyAvatarMouseOver);s.on(o,"mouseout",r.onMyPanelMyAvatarMouseOut);}s.on(b,"click",r.onMyPanelExitButtonClick);s.on(t.id("EQQ_mySignature_input"),"keyup",y);};var y=function(){c(this,150);};var c=function(C,A){var z=String(C.value);var B=z.replace(/[^\x00-\xff]/g,"aaa").length;if(B>A){C.value=k.string.cutRight(z,1);c(C,A);}};var g=function(z){x=z;if(!z){z="点击编辑签名";}var A=z;if(k.browser.firefox){A=k.string.cutByWidth(A,12,90);}f.innerHTML=k.string.encodeHtml(A);f.title=(z);e.value="";};var i=function(z){o.src=qqweb.util.getUserAvatar(z.uin,1)+"&t="+(new Date()).getTime();p.innerHTML=z.htmlNick;p.title=z.titleNick+"<"+z.uin+">";};var r={onRun:function(z){qqweb.portal.self={uin:qqweb.portal.getCookieUin()};n(qqweb.portal.self);s.addObserver(qqweb.rpcService,"GetUserInfoSuccess",r.onGetUserInfoSuccess);s.addObserver(qqweb.rpcService,"GetUserInfoError",r.onGetUserInfoError);s.addObserver(qqweb.portal,"eqqCloseClick",r.onEqqClose);s.addObserver(qqweb.portal,"UserAvatarChanged",r.onUserAvatarChanged);s.addObserver(qqweb.portal,"GetLoginInfoSuccess",r.onGetLoginInfoSuccess);},onGetUserInfoSuccess:function(B){t.hide(w);t.show(j);var A=B.arguments.uin;var z=B.result;if(qqweb.portal.self.uin===A){var C=z;qqweb.portal.setPortalSelf(C);}qqweb.portal.setIsLoginSuccess(true);s.notifyObservers(qqweb.portal,"selfInfoReady",qqweb.portal.self);i(qqweb.portal.self);},onGetUserInfoError:function(A){var z=A.arguments.uin;if(qqweb.portal.self.uin===z){t.hide(j);t.show(w);}},onNeedLogin:function(z){alert("请先登录");},onMyPanelMyAvatarClick:function(){var z=parseInt(this.getAttribute("uin"),10);qqweb.portal.runApp("userDetails",z);pgvSendClick({hottag:"web2qq.corner.topright.icon"});},onMyPanelMyAvatarMouseOver:function(B){var z=qqweb.portal.self.uin;if(EQQ.avatarMouseoverTimer){clearTimeout(EQQ.avatarMouseoverTimer);EQQ.avatarMouseoverTimer=null;}var A=t.getClientXY(this);A[0]=A[0]-218;A[1]=A[1]-3;EQQ.Presenter.MainPanel.showMiniCardPanel(z,A);},onMyPanelMyAvatarMouseOut:function(z){EQQ.avatarMouseoverTimer=window.setTimeout(r.onTimeHideMiniCardPanel,500);},onTimeHideMiniCardPanel:function(){EQQ.Presenter.MainPanel.hideMiniCardPanel();},onQZoneButtonClick:function(z){z.preventDefault();qqweb.portal.runApp("16",{});pgvSendClick({hottag:"web2qq.corner.topright.qzone"});},onMyPanelExitButtonClick:function(z){qqweb.portal.exit();s.notifyObservers(qqweb.portal,"Exit");pgvSendClick({hottag:"WEB2QQ.TASKBAR.EXIT.LOGIN"});},onLoginButtonClicked:function(){qqweb.portal.showLoginWindow("",true);},onSignatureClicked:function(z){z.preventDefault();v.toggleSignatureToEditor();pgvSendClick({hottag:"web2qq.corner.topright.personalmsg"});},onSignatureKeyDown:function(z){switch(z.keyCode){case 13:v.confirmSignatureEdit();break;case 27:v.cancelSignatureEdit();default:}},onSignatureCancel:function(){},onSignatureBlur:function(){v.confirmSignatureEdit();},onWdinwoClose:function(z){v.closeWindow(z.uin);},onEqqClose:function(){t.hide(a);},onUserAvatarChanged:function(){var z=qqweb.portal.self.uin;o.src=qqweb.util.getUserAvatar(z,1)+"&t="+(new Date()).getTime();},onGetLoginInfoSuccess:function(){qqweb.rpcService.sendGetUserInfo(qqweb.portal.self.uin);qqweb.rpcService.send(qqweb.CONST.API_SERVER_URL+"get_single_long_nick2",{context:v,method:"GET",data:{tuin:qqweb.portal.self.uin,vfwebqq:qqweb.portal.getVfWebQQ()},arguments:{tuin:qqweb.portal.self.uin},onSuccess:function(A){if(A.retcode===0){var z="";if(A.result.length!=0){z=A.result[0].lnick;}g(z);}else{k.out("[sendGetSelfSignature] error: "+A.retcode+"-"+A.errmsg);}}});}};s.addObserver(this,"run",r.onRun);s.addObserver(this,"needLogin",r.onNeedLogin);this.toggleSignatureToEditor=function(){s.on(e,"keydown",r.onSignatureKeyDown);s.on(e,"blur",r.onSignatureBlur);t.hide(f);t.show(e);e.value=x;e.focus();e.select();};this.toggleSignatureToShow=function(){s.off(e,"keydown",r.onSignatureKeyDown);s.off(e,"blur",r.onSignatureBlur);t.hide(e);t.show(f);};this.cancelSignatureEdit=function(){this.toggleSignatureToShow();};this.confirmSignatureEdit=function(){this.toggleSignatureToShow();if(e.value==x){return;}f.title=("签名更新中:"+e.value);this.sendSetSignatuer(e.value);};this.getWindow=function(z){return uin2window[z];};this.setWindow=function(z,A){uin2window[z]=A;windowList.push(A);A.uin=z;return A;};this.closeWindow=function(z){var A=uin2window[z];k.array.remove(windowList,A);delete uin2window[z];return true;};this.closeAllWindow=function(){for(var z=0;z<windowList.length;z++){this.closeWindow(windowList[z].uin);}return true;};this.sendSetSignatuer=function(z){var A=qqweb.rpcService.send(qqweb.CONST.API_SERVER_URL+"set_long_nick2",{context:v,method:"POST",data:"r="+encodeURIComponent(k.json.stringify({nlk:z,vfwebqq:qqweb.portal.getVfWebQQ()})),arguments:{nlk:z},onSuccess:function(B){if(B.retcode===0){v.onSetSelfSignatureSuccess(z);}else{alert("签名修改失败");k.out("[sendSetSelfSignature] error: "+B.retcode+"-"+B.errmsg);}}});};this.onSetSelfSignatureSuccess=function(z){g(z);pgvSendClick({hottag:"web2qq.corner.topright.personalmsgsuccess"});};});
